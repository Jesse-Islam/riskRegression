#+TITLE: Testing k-fold CV
#+OPTIONS: H:3 num:t toc:nil \n:nil @:t ::t |:t ^:t -:t f:t *:t <:t
#+OPTIONS: TeX:t LaTeX:t skip:nil d:t todo:t pri:nil tags:not-in-toc author:nil
#+LaTeX_CLASS: org-article
#+LaTeX_HEADER:\usepackage{authblk}
#+LaTeX_HEADER:\usepackage{natbib}
#+LaTeX_HEADER:\author{Anders Munch}
#+LaTeX_HEADER:\affil{University of Copenhagen, Department of Public Health, Section of Biostatistics, Copenhagen, Denmark}


* Testing
Copy/paste some functionality form other vignette.

Packages and source for reloading after edits.
#+BEGIN_SRC R  :results output   :exports silent  :session *R* :cache yes
library(riskRegression)
library(data.table)
library(Publish)
## source("./R/getNullModel.R")
## source("./R/getResponse.R")
## source("./R/Score.R")
sessionInfo()
#+END_SRC

#+RESULTS[<2019-06-13 09:25:58> 89bbea24d7a593489c4d8d082db5a2eb5946e265]:
#+begin_example
R version 3.6.0 (2019-04-26)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 18.04.2 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.7.1
LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.7.1

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C               LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8    LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C             LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices datasets  utils     methods   base     

other attached packages:
[1] Publish_2019.03.11        prodlim_2018.04.18        data.table_1.12.2         riskRegression_2019.06.13
[5] Refresh_2019-04-11       

loaded via a namespace (and not attached):
 [1] Rcpp_1.0.1          mvtnorm_1.0-10      lattice_0.20-38     zoo_1.8-5           assertthat_0.2.1   
 [6] digest_0.6.19       foreach_1.4.4       R6_2.4.0            plyr_1.8.4          backports_1.1.4    
[11] acepack_1.4.1       MatrixModels_0.4-1  ggplot2_3.1.1       pillar_1.4.0        rlang_0.3.4        
[16] lazyeval_0.2.2      multcomp_1.4-10     rstudioapi_0.10     SparseM_1.77        rpart_4.1-15       
[21] Matrix_1.2-17       checkmate_1.9.3     splines_3.6.0       stringr_1.4.0       foreign_0.8-71     
[26] htmlwidgets_1.3     munsell_0.5.0       numDeriv_2016.8-1   compiler_3.6.0      xfun_0.7           
[31] pkgconfig_2.0.2     base64enc_0.1-3     htmltools_0.3.6     nnet_7.3-12         tidyselect_0.2.5   
[36] tibble_2.1.1        gridExtra_2.3       htmlTable_1.13.1    Hmisc_4.2-0         rms_5.1-3.1        
[41] codetools_0.2-16    crayon_1.3.4        dplyr_0.8.1         MASS_7.3-51.4       timereg_1.9.3      
[46] grid_3.6.0          nlme_3.1-140        polspline_1.1.14    gtable_0.3.0        magrittr_1.5       
[51] scales_1.0.0        stringi_1.4.3       latticeExtra_0.6-28 sandwich_2.5-1      Formula_1.2-3      
[56] TH.data_1.0-10      lava_1.6.5          RColorBrewer_1.1-2  iterators_1.0.10    tools_3.6.0        
[61] cmprsk_2.2-7        glue_1.3.1          purrr_0.3.2         survival_2.44-1.1   colorspace_1.4-1   
[66] cluster_2.0.9       knitr_1.23          quantreg_5.38
#+end_example


Setup data
#+BEGIN_SRC R  :results output raw drawer  :exports code  :session *R* :cache yes
  set.seed(18)
  astrain <- simActiveSurveillance(278)
  astest <- simActiveSurveillance(208)
  astrain[,Y1:=1*(event==1 & time<=1)]
  astest[,Y1:=1*(event==1 & time<=1)]
  lrfit.ex <- glm(Y1~age+lpsaden+ppb5+lmax+ct1+diaggs,data=astrain,family="binomial")
  lrfit.inc <- glm(Y1~age+lpsaden+ppb5+lmax+ct1+diaggs+erg.status,data=astrain,family="binomial")
Score(list("Exclusive ERG"=lrfit.ex,"Inclusive ERG"=lrfit.inc),data=astest,formula=Y1~1,se.fit=0L,metrics="brier",contrasts=FALSE) 
#+END_SRC

#+RESULTS[<2019-06-13 09:25:58> d42bd03051fd4b36155783dfceaa8621ff828894]:
:results:
:end:


Does some weird thing when simply putting =split.method = "bootcv"=:

#+BEGIN_SRC R  :results verbatim output  :exports both  :session *R* :cache yes
Score(list("Exclusive ERG"=lrfit.ex,"Inclusive ERG"=lrfit.inc),data=astest,formula=Y1~1,se.fit=0L,metrics="brier",contrasts=FALSE,split.method = "bootcv",B=3) # Setting B=3 only to make small output
#+END_SRC

#+RESULTS[<2019-06-13 09:25:59> d773be5d61308feff941a2d7f8f2965d2f28a496]:
#+begin_example
Running crossvalidation ...
  |                                                                                                                      |                                                                                                              |   0%  |                                                                                                                      |=====================================                                                                         |  33%  |                                                                                                                      |=========================================================================                                     |  67%  |                                                                                                                      |==============================================================================================================| 100%  |                                                                                                                      |                                                                                                              |   0%Running crossvalidation ...
  |                                                                                                                      |==============================================================================================================| 100%Running crossvalidation ...
Running crossvalidation ...


Metric Brier:

Results by model:

           model Brier
1:    Null model 0.172
2: Exclusive ERG 0.173
3: Inclusive ERG 0.168

Bootstrap cross-validation based on 3 bootstrap samples (drawn with replacement) each of size 208.
#+end_example

Error seems to be caused by line 880:
#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes
if (f==0) model.f=nullobject[[1]] else model.f=object[[f]]
#+END_SRC
because it =Y= is not in the nullmodel. Not sure what /should/ happen here.


#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes
  X1 <- Score(list("Exclusive ERG"=lrfit.ex,"Inclusive ERG"=lrfit.inc),data=astest,
	      formula=Y1~1,summary="ipa",se.fit=0L,metrics="brier",contrasts=FALSE)

#+END_SRC

#+RESULTS[<2019-06-13 09:25:59> 6bf06ef2848228d40ca4ec36538f086afd1ae3c4]:
:results:
Error: object 'f' not found
:end:
